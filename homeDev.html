<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	</head>
	<body>
		<form name="logForm">
			Login :<input type="text" name="login" id="login"> <br>
			Password :<input type="password" name="password" id="password"> <br>
			<button type="button" id="btn-token"> Authenticate </button>
			<!-- Welcome + Login -->
			<div id="welcome"><p>Welcome !</p></div> <br>
		</form>
		<form name="gameOptionForm">
			Create game name :<input type="text" name="game_name" id="game_name"> <br>
			Number of players :<input type="number" name="number_players" id="number_players" min="5" max="10"> <br>
			<button type="button" id="btn-create_game"> Create </button>
			<button type="button" id="btn-show_game"> Show </button> <br>
			
			<table id="games_table"></table>
			
			
			<select name="drop-down-list" id="dropdown"><!-- Js populating options --></select> <br>
			<button type="button" id="btn-list_players"> List Players </button>
			<!-- Game ID to show -->
			<div id="game_to_show"><p>No game to show</p></div>
			<button type="button" id="btn-join_game"> Join </button>
			<!-- Game joined -->
			<div id="game_joined"><p>No game joined</p></div>
		</form>
		
		
		
		
		<!-- http://handlebarsjs.com/  -->
		<!-- https://github.com/janl/mustache.js -->
		<!-- Documentation github.com/elwinar/the-resistance   -->
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
		<script> 
		
			var cfg = {
				domain: "http://ogg.elwinar.com:56789",
			};

			var state = {
				token: '',
			};
			
			var game = {
				id: '',
				players: '',
				created_at: '',
				started_at: '',
				finished_at: '',
				name: '',
				joined:''
			}
			
			var player = {
				login: '',
				password: ''
			}
			
			$(document).ready(function() {
				console.log( "ready!" );
			});

			
			//Get token from server then authenticate
			$('#btn-token').on("click", function getToken() {
				player.login = $('#login').val();
				player.password = $('#password').val();
				var payload = {
					"login" : player.login,
					"password" : player.password
				};
				$.ajax({
					type: 'POST',
					dataType: 'json',
					url: cfg.domain + '/login',
					data: JSON.stringify(payload),
					success: function(data) {
						state.token = data.token;
						console.log("Your token : " + state.token);
						authentication();
						getListGames();
					},
				}); 
			});
					
			//Authentication
			function authentication() {
				$.ajax({
					type: 'POST',
					dataType: 'json',
					url: cfg.domain + '/authenticate',
					headers: {
						'token': state.token,
					},
					success: function(data) {
						if(data.authenticated) {
							console.log(player.login + " is authenticated");
						} else {
							console.log("Error authentication");
						}
						$('#welcome p').text("Welcome " + player.login + " !");
					},
				}); 
			}
			
			//List all games
			function getListGames() {
				$('#dropdown').empty(); //clear drop-down list
				$('#games_table tr').remove(); //clear table
				$.ajax({
					type: 'GET',
					dataType: 'json',
					url: cfg.domain + '/game',
					headers: {
						'token': state.token,
					},
					success: function(data) {
						var games = [];
						for(var i = 0; i < data.length; i++) {
							games.push({ 
								id: data[i].id, 
								name: data[i].name,
								players: data[i].players, 
								created_at: data[i].created_at, 
								started_at: data[i].started_at, 
								finished_at: data[i].finished_at,
								joined: data[i].joined
							});
							//$('#dropdown').append('<option value=' + data[i].id + '>' + data[i].name + '</option>');
							$('#games_table').append('<tr><td>' + data[i].id + '</td><td>' + data[i].name + '</td><td>' + data[i].players + '</td><td>' + data[i].created_at + '</td><td>' + data[i].started_at + '</td><td>' + data[i].finished_at + '</td><td>' + data[i].joined + '</td><td><input value="'</td></tr>');
							console.log(games[i].id + " " + games[i].players + " " + games[i].created_at + " " + games[i].started_at + " " + games[i].finished_at + " " + games[i].name + " " + games[i].joined);
						}
					},
				});
			}
			

			
			//Show a game by ID
			$('#btn-show_game').on("click", function showGame() {
				var game_id_dropdown = $('#dropdown :selected').val();
				$.ajax({
					type: 'GET',
					dataType: 'json',
					url: cfg.domain + '/game/' + game_id_dropdown,
					headers: {
						'token': state.token,
					},
					success: function(data) {
						$('#game_to_show p').text("Game ID : " + data.id + " Name : " + data.name);
					},
				}); 
			});
			
			//Create a game
			$('#btn-create_game').on("click", function createGame() {
				var new_game_name = $('#game_name').val();
				var number_players = $('#number_players').val();
				var payload = {
					"name": new_game_name,
					"players": parseInt(number_players)
				};

				$.ajax({
					type: 'POST',
					dataType: 'json',
					url: cfg.domain + '/game',
					data: JSON.stringify(payload),
					headers: {
						'token': state.token,
					},
					success: function(data) {
						getListGames();
						console.log(new_game_name + " game created");
					},
				}); 
			});			
			
			
			//Join a game with his name
			$('#btn-join_game').on("click", function joinGame() {
				var join_game_name = $('#dropdown :selected').text();
				var game_id_dropdown = $('#dropdown :selected').val();
				var payload = {
						"name": join_game_name,
				};
				$.ajax({
					type: 'POST',
					dataType: 'json',
					url: cfg.domain + '/game/' + game_id_dropdown + '/join',
					data: JSON.stringify(payload),
					headers: {
						'token': state.token,
					},
					success: function(data) {
						$('#game_joined p').text("Game : " + join_game_name + " joined ! Player(s) in the room : " /*+ number player*/);
						console.log("Player in the room : " + data.player);
					},
				});
			});
			
			//List all players in a game
			$('#btn-list_players').on("click", function getListPlayersInGame() {
				var game_id_dropdown = $('#dropdown :selected').val();
				$.ajax({
					type: 'GET',
					dataType: 'json',
					url: cfg.domain + '/game/' + game_id_dropdown + '/players',
					headers: {
						'token': state.token,
					},
					success: function(data) {
						var players = [];
						if (data.length != null) {
							for(var i = 0; i < data.length; i++) {
								players.push({ 
									id: data[i].id, 
									user_id: data[i].user_id,
									name: data[i].name, 
									joined_at: data[i].joined_at, 
								});
								console.log(players[i].id + " " + players[i].user_id + " " + players[i].joined_at + " " + players[i].name);
							}
						} else {
							console.log("No players in this game");
						}
					},
				});
			});
			
			
			
			/*$("#butt").onclick function(eu)
					$(window).fire('page_change' $(eu.target).attr[href])
			*/
		</script>
	</body>
</html>